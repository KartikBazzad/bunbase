# Bundoc + BunKMS Integration

This document details how **Bundoc** (Document Store) utilizes **BunKMS** (Key Management Service) to provide encryption-at-rest for user data, ensuring project isolation and security.

## Problem Statement

Bundoc stores JSON documents on disk. If the underlying disk is compromised, all data is readable. Additionally, in a multi-tenant system, we want to ensure cryptographic isolation between projects.

## Solution: Envelope Encryption

We implement a localized version of Envelope Encryption:

1.  **KEK (Key Encryption Key)**: Managed by BunKMS. Never leaves BunKMS software vault.
2.  **DEK (Data Encryption Key)**: Unique per Project. Generated by BunKMS, wrapped by the KEK, and stored alongside Bundoc data (future state). _Current MVP_: Bundoc requests raw DEK over secure channel.

## Workflow

### 1. Project Initialization (Lazy)

When Bundoc receives the first write request for `Project-A`:

1.  **Cache Check**: Bundoc checks `in-memory map[projectID]Key` for `Project-A`.
2.  **Fetch**: If missing, calls BunKMS: `GET /v1/export/project-a-dek`.
    - _Auth_: Uses Service Token with `kms:export_key` scope.
3.  **Create**: If 404, calls `POST /v1/keys { "name": "project-a-dek", "type": "aes-256" }`. Then repeats Fetch.
4.  **Cache**: Stores the raw 32-byte key in memory with a **TTL of 15 minutes**.

### 2. Data Write

1.  Bundoc receives JSON: `{ "foo": "bar" }`.
2.  Bundoc serializes to bytes.
3.  **Encrypt**: Generates random 12-byte Nonce. Uses AES-256-GCM with cached DEK.
4.  **Write**: `[Nonce (12b) | Ciphertext]` written to disk: `./data/projects/project-a/docs/...`.

### 3. Data Read

1.  Bundoc reads file.
2.  Splits Nonce and Ciphertext.
3.  **Decrypt**: Uses cached DEK.
4.  Returns JSON.

## BunKMS API Requirements

Bundoc needs a privileged endpoint to retrieve the raw key material for high-performance local crypto.

**Endpoint**: `GET /v1/export/{key_name}`
**Auth**: strictly `service` tokens.

**Response**:

```json
{
  "key_material_b64": "mv7...", // Base64 encoded 32-byte key
  "algorithm": "AES-256-GCM"
}
```

## Security Controls

1.  **Memory Safety**: The raw DEK resides in Bundoc's RAM.
    - _Mitigation_: We will use a `memguard` library or similar in future to prevent swap-out, but standard Go heap is acceptable for MVP.
2.  **Network**: The `export` endpoint is only accessible on the internal Docker network.
3.  **Audit**: Every access to `/export` is logged in BunKMS audit log as a `CRITICAL` event.

## Implementation Steps

1.  **BunKMS**:
    - Implement `GET /v1/export/{name}`.
    - Add `kms:export_key` scope check.
2.  **Bundoc**:
    - Refactor `InstanceManager` to hold `KeyCache`.
    - Implement `KMSClient` with retry logic (if KMS is down, Bundoc is down for cold projects).
    - Wrap file I/O with `Encrypt/Decrypt` transformer.
