http:
  middlewares:
    # Rewrite path so platform receives /_/invoke/<path> (avoids Gin conflict with /v1)
    platform-invoke-prefix:
      ReplacePathRegex:
        regex: "^/(.*)"
        replacement: "/_/invoke/$${1}"

  routers:
    # Path-based: API and health (highest priority so /api always goes to platform)
    platform:
      rule: "PathPrefix(`/api`) || PathPrefix(`/kv`) || Path(`/health`)"
      service: platform
      entryPoints:
        - web
      priority: 200

    # Custom domain routing for functions:
    # - {slug}.bunbase.com/function-name
    # - {projectID}.functions.bunbase.com/function-name
    function-subdomain:
      rule: "HostRegexp(`{subdomain:.+}\\.bunbase\\.com`) && PathPrefix(`/`)"
      service: platform
      middlewares:
        - platform-invoke-prefix
      entryPoints:
        - web

    function-generated:
      rule: "HostRegexp(`{project:.+}\\.functions\\.bunbase\\.com`) && PathPrefix(`/`)"
      service: platform
      middlewares:
        - platform-invoke-prefix
      entryPoints:
        - web

    # Console app at console.localhost (host-based)
    console:
      rule: "Host(`console.localhost`)"
      service: web
      entryPoints:
        - web
      priority: 100

  services:
    platform:
      loadBalancer:
        servers:
          - url: "http://bunbase-platform:3001"

    web:
      loadBalancer:
        servers:
          - url: "http://bunbase-web:80"
