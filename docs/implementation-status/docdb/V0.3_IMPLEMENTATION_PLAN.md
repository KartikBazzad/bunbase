# DocDB v0.3 Implementation Plan

**Version:** v0.3  
**Last Updated:** January 28, 2026

## Overview

v0.3 focuses on **performance, concurrency, and observability**:

1. **Ants goroutine pool** – Replace custom scheduler workers with [ants/v2](https://pkg.go.dev/github.com/panjf2000/ants/v2) for recycling, panic recovery, and configurable expiry.
2. **WAL group commit** – Wire FsyncConfig into WAL writer so batched fsync (group/interval) is used instead of per-write fsync.
3. **Fast WAL replay** – Single-pass replay and deferred datafile sync during apply to reduce startup time.
4. **Scheduler fairness** – Queue-depth–aware scheduling so the busiest DB gets more service under skewed workloads.
5. **Metrics** – Expose WAL group-commit and ants pool metrics (batch size, fsync latency, running/waiting/free workers).
6. **Parallel healing** – Use ants PoolWithFunc for batch healing (HealAll, performHealthScan).
7. **Optional IPC connection pool** – Cap concurrent connection handlers via MaxConnections when set.

## Goals

- Reduce goroutine churn and memory via ants recycling.
- Improve throughput and latency via WAL group commit and fairness.
- Shorten DB open time after restart via fast replay.
- Improve observability (WAL batch size, fsync latency, ants pool stats).
- Bounded connection handling when MaxConnections > 0.

## Scope

| Area      | In scope                                     | Out of scope                   |
| --------- | -------------------------------------------- | ------------------------------ |
| Scheduler | Ants pool for workers, panic handler, expiry | MultiPool (optional, deferred) |
| WAL       | Group commit wired, FsyncConfig              | Async WAL writer               |
| Replay    | Single-pass, WriteNoSync, one Sync at end    | Index snapshot at checkpoint   |
| Healing   | Ants PoolWithFunc for parallel heal          | New healing algorithms         |
| IPC       | Optional connection pool                     | Protocol changes               |
| Config    | WorkerExpiry, PreAlloc, MaxConnections       | New transport options          |

## Implementation Phases

### Phase 1: Scheduler worker pool (ants)

- Add dependency: `github.com/panjf2000/ants/v2`.
- Config: `SchedulerConfig.WorkerExpiry`, `SchedulerConfig.PreAlloc`.
- In `pool/scheduler.go`: create `ants.Pool` in `Start()` with `WithExpiryDuration`, `WithPreAlloc`, `WithPanicHandler`; submit N worker loops via `Submit(func() { s.worker() })`; in `Stop()` call `ReleaseTimeout(3s)` after `wg.Wait()`.
- Expose ants stats: `GetAntsStats()` → `running_workers`, `waiting_tasks`, `free_workers`, `pool_capacity`; include in `GetSchedulerStats()` as `ants_pool`.
- Fallback: if `NewPool` fails, start N goroutines as before.

### Phase 2: WAL group commit wired

- In `wal/writer.go`: add `NewWriterFromConfig(path, dbID, maxSize, walCfg *config.WALConfig, log)`; when `Fsync.Mode` is Group or Interval, create and start `GroupCommit` in `Open()`, use `groupCommit.Write(record)` in Write/WriteCommitMarker/WriteCheckpoint; in `Sync()`/`Close()`/`rotateLocked()` stop/flush group commit as needed.
- In `docdb/core.go`: use `wal.NewWriterFromConfig(..., &db.cfg.WAL, log)` instead of `NewWriter(..., FsyncOnCommit, ...)`.

### Phase 3: Fast WAL replay

- In `docdb/datafile.go`: add `WriteNoSync(payload)` (same as Write but no fsync).
- In `docdb/core.go` `replayWAL()`: merge checkpoint scan and buffer pass into one Replay() pass; in apply phase use `dataFile.WriteNoSync` for all Create/Update payloads; call `dataFile.Sync()` once at end of replay.

### Phase 4: Scheduler fairness

- In `pool/scheduler.go`: add `PickNextQueue()` returning (dbID, queue) for the queue with largest current depth; in `worker()` use `PickNextQueue()` instead of round-robin index to choose which queue to service.

### Phase 5: WAL/group-commit metrics

- In `wal/writer.go`: add `GetGroupCommitStats() (GroupCommitStats, bool)`.
- In `docdb/core.go`: add `GetWALStats() map[string]interface{}` (calls wal.GetGroupCommitStats(), returns serializable map).
- In `pool/pool.go` `GetSchedulerStats()`: aggregate per-DB `GetWALStats()` into `wal_group_commit` key.

### Phase 6: Healing parallelization (ants)

- In `docdb/healing.go`: add `healTask` / `healTaskWithWg`; `getHealPool()` creates `ants.PoolWithFunc(MaxBatchSize, healFunc)` with panic handler; `HealAll()` and `performHealthScan()` collect corrupted (collection, docID), submit to pool, wait; release pool in `Stop()`.

### Phase 7: IPC connection pool (optional)

- Config: `IPCConfig.MaxConnections` (0 = unlimited).
- In `ipc/server.go`: when `MaxConnections > 0`, create `ants.Pool(MaxConnections)` in `Start()`; in `acceptLoop()` submit `func() { defer wg.Done(); handleConnection(conn) }` to pool instead of `go handleConnection(conn)`; in `Stop()` release pool after `wg.Wait()`.

## Configuration (v0.3)

```go
// SchedulerConfig
WorkerExpiry  time.Duration // default: 1s (ants goroutine expiry)
PreAlloc      bool          // default: false (ants pre-allocate ring buffer)

// IPCConfig
MaxConnections int          // default: 0 (unlimited); if > 0, use ants connection pool
```

## Metrics (v0.3)

- **GetSchedulerStats()**
  - `ants_pool`: `running_workers`, `waiting_tasks`, `free_workers`, `pool_capacity` (when ants used).
  - `wal_group_commit`: per-DB map of `total_batches`, `total_records`, `avg_batch_size`, `avg_batch_latency_ns`, `max_batch_size`, `max_batch_latency_ns`, `last_flush_time_unix_ns` (when group commit active).

## Testing

- Existing multi-DB load tests; compare throughput and P95 before/after.
- Verify ants pool stats and WAL group-commit stats in GetSchedulerStats().
- Restart with large WAL; confirm replay time is reduced.
- Optional: panic injection in worker to confirm ants panic handler logs and does not crash.

## Dependencies

- `github.com/panjf2000/ants/v2` (MIT).

## References

- [ants v2 – pkg.go.dev](https://pkg.go.dev/github.com/panjf2000/ants/v2)
- Sprint 1 / Sprint 2 performance work (session summary)
- `docdb/internal/pool/scheduler.go`, `docdb/internal/wal/writer.go`, `docdb/internal/docdb/core.go`, `docdb/internal/docdb/healing.go`, `docdb/internal/ipc/server.go`
