# DocDB v0.3 Implementation Status

**Version:** v0.3  
**Last Updated:** January 28, 2026

## Summary

**Status:** v0.3 complete – Ants goroutine pool integration, WAL group commit wired, fast WAL replay, scheduler fairness, WAL/ants metrics, parallel healing, and optional IPC connection pool are implemented and documented.

v0.3 focuses on **performance, concurrency, and observability**: goroutine recycling and panic recovery via ants, batched WAL fsync, faster startup replay, queue-depth–aware scheduling, and richer metrics.

---

## Completed Features

### 1. Ants goroutine pool (scheduler)

**Status:** Complete

**Implementation:**

- Scheduler workers use `ants.Pool` instead of raw `go s.worker()`.
- Pool created in `Start()` with `WithExpiryDuration(WorkerExpiry)`, `WithPreAlloc(PreAlloc)`, `WithPanicHandler` (logs via `*logger.Logger`).
- N worker loops submitted via `antsPool.Submit(func() { s.worker() })`.
- `Stop()`: set stopped, close queues, `wg.Wait()`, then `antsPool.ReleaseTimeout(3s)`.
- Fallback: if `ants.NewPool` fails, N goroutines are started as before.

**Files:**

- `docdb/go.mod` – dependency `github.com/panjf2000/ants/v2`
- `docdb/internal/config/config.go` – `SchedulerConfig.WorkerExpiry`, `PreAlloc`
- `docdb/internal/pool/scheduler.go` – ants pool creation, `SetAntsOptions`, `GetAntsStats()`
- `docdb/internal/pool/pool.go` – `SetAntsOptions` in `NewPool`, `ants_pool` in `GetSchedulerStats()`

**Configuration:**

- `Sched.WorkerExpiry` – goroutine expiry (default: 1s)
- `Sched.PreAlloc` – pre-allocate worker queue (default: false)

---

### 2. WAL group commit wired

**Status:** Complete

**Implementation:**

- `wal.NewWriterFromConfig(path, dbID, maxSize, walCfg *config.WALConfig, log)` uses `walCfg.Fsync`; when `Mode` is FsyncGroup or FsyncInterval, writer uses internal `GroupCommit`.
- In `Open()`, when group commit is used, `NewGroupCommit(file, fsyncConfig, log)` is created and `Start()` is called.
- `Write`, `WriteCommitMarker`, `WriteCheckpoint` call `groupCommit.Write(encodedRecord)` when group commit is active; otherwise direct file write + optional fsync.
- `Sync()`, `Close()`, and `rotateLocked()` stop/flush group commit and sync/close file as needed.
- `docdb/core.go` uses `wal.NewWriterFromConfig(walFile, dbID, maxSize, &db.cfg.WAL, log)`.

**Files:**

- `docdb/internal/wal/writer.go` – `fsyncConfig`, `groupCommit`, `NewWriterFromConfig`, group commit in Open/Write/Sync/Close/rotateLocked
- `docdb/internal/docdb/core.go` – `NewWriterFromConfig` for WAL

---

### 3. Fast WAL replay

**Status:** Complete

**Implementation:**

- Single-pass replay: checkpoint discovery and record buffering done in one `replaySegment` pass; `lastCheckpointTxID` updated on OpCheckpoint; committed transactions after checkpoint are applied.
- `DataFile.WriteNoSync(payload)` added – same append as Write but no fsync.
- During apply, all Create/Update payloads use `dataFile.WriteNoSync`; at end of replay `dataFile.Sync()` is called once.

**Files:**

- `docdb/internal/docdb/datafile.go` – `WriteNoSync`
- `docdb/internal/docdb/core.go` – `replayWAL()` single pass, `WriteNoSync` in apply, single `Sync()` at end

---

### 4. Scheduler fairness (queue-depth–aware)

**Status:** Complete

**Implementation:**

- `PickNextQueue() (dbID, queue)` returns the DB queue with the largest current depth (or 0, nil if none have work).
- Worker loop uses `PickNextQueue()` instead of round-robin index so the busiest DB gets more service under skewed load.

**Files:**

- `docdb/internal/pool/scheduler.go` – `PickNextQueue()`, worker uses it

---

### 5. WAL and group-commit metrics

**Status:** Complete

**Implementation:**

- `wal.Writer.GetGroupCommitStats() (GroupCommitStats, bool)` – returns group commit stats when active.
- `LogicalDB.GetWALStats() map[string]interface{}` – returns serializable map (total_batches, total_records, avg_batch_size, avg_batch_latency_ns, max_batch_size, max_batch_latency_ns, last_flush_time_unix_ns) or nil.
- `Pool.GetSchedulerStats()` aggregates per-DB `GetWALStats()` into `wal_group_commit` and includes `ants_pool` when ants is used.

**Files:**

- `docdb/internal/wal/writer.go` – `GetGroupCommitStats()`
- `docdb/internal/docdb/core.go` – `GetWALStats()`
- `docdb/internal/pool/pool.go` – `wal_group_commit` and `ants_pool` in `GetSchedulerStats()`
- `docdb/internal/pool/scheduler.go` – `GetAntsStats()`

---

### 6. Parallel healing (ants)

**Status:** Complete

**Implementation:**

- `HealingService` uses `ants.PoolWithFunc` for batch healing; capacity = `MaxBatchSize` (or 4 if 0).
- Task type `healTaskWithWg` (Collection, DocID, Wg, Healed slice, HealedMu) so workers can HealDocument and append to healed list with mutex.
- `getHealPool()` lazily creates pool with panic handler; `HealAll()` and `performHealthScan()` collect corrupted (collection, docID), submit to pool, wait; only successfully healed docIDs are counted.
- `Stop()` releases heal pool.

**Files:**

- `docdb/internal/docdb/healing.go` – `healTask`, `healTaskWithWg`, `getHealPool()`, `HealAll()` and `performHealthScan()` parallelized, pool release in `Stop()`

---

### 7. Optional IPC connection pool

**Status:** Complete

**Implementation:**

- When `cfg.IPC.MaxConnections > 0`, server creates `ants.Pool(MaxConnections)` in `Start()` with panic handler.
- In `acceptLoop()`, new connections are handled by `connPool.Submit(func() { defer wg.Done(); handleConnection(conn) })` when pool is set; otherwise `go handleConnection(conn)` (unchanged).
- In `Stop()`, after `wg.Wait()`, `connPool.ReleaseTimeout(3s)` is called.

**Files:**

- `docdb/internal/config/config.go` – `IPCConfig.MaxConnections`
- `docdb/internal/ipc/server.go` – `connPool`, creation in `Start()`, submit in `acceptLoop()`, release in `Stop()`

---

## Configuration reference (v0.3)

| Config               | Type          | Default | Description                                        |
| -------------------- | ------------- | ------- | -------------------------------------------------- |
| `Sched.WorkerExpiry` | time.Duration | 1s      | Ants goroutine expiry                              |
| `Sched.PreAlloc`     | bool          | false   | Ants pre-allocate worker queue                     |
| `IPC.MaxConnections` | int           | 0       | Max concurrent connection handlers (0 = unlimited) |

---

## Metrics (v0.3)

**GetSchedulerStats()** may include:

- `queue_depths` – per-DB queue depth (unchanged)
- `avg_queue_depth`, `worker_count` (unchanged)
- `ants_pool` – when ants is used: `running_workers`, `waiting_tasks`, `free_workers`, `pool_capacity`
- `wal_group_commit` – per-DB when group commit is active: `total_batches`, `total_records`, `avg_batch_size`, `avg_batch_latency_ns`, `max_batch_size`, `max_batch_latency_ns`, `last_flush_time_unix_ns`

---

## Deferred / optional

- **MultiPool for per-DB isolation** – Plan included optional use of `ants.MultiPool` with LeastTasks; deferred in favor of current queue-depth–aware single pool.
- **WAL group commit parallelization** – Multiple WAL files could use a pool for parallel flush; not required for current single-WAL-per-DB design.

---

## Files changed (v0.3)

| Area       | Files                                                                                                                                                              |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Dependency | `docdb/go.mod`                                                                                                                                                     |
| Config     | `docdb/internal/config/config.go`                                                                                                                                  |
| Scheduler  | `docdb/internal/pool/scheduler.go`, `docdb/internal/pool/pool.go`                                                                                                  |
| WAL        | `docdb/internal/wal/writer.go`                                                                                                                                     |
| Core       | `docdb/internal/docdb/core.go`, `docdb/internal/docdb/datafile.go`                                                                                                 |
| Healing    | `docdb/internal/docdb/healing.go`                                                                                                                                  |
| IPC        | `docdb/internal/ipc/server.go`                                                                                                                                     |
| Docs       | `docdb/README.md`, `docdb/docs/architecture.md`, `docs/implementation-status/docdb/V0.3_IMPLEMENTATION_PLAN.md`, `docs/implementation-status/docdb/V0.3_STATUS.md` |

---

## References

- [V0.3_IMPLEMENTATION_PLAN.md](V0.3_IMPLEMENTATION_PLAN.md) – v0.3 plan
- [ants v2](https://pkg.go.dev/github.com/panjf2000/ants/v2)
- [V0.2_STATUS.md](V0.2_STATUS.md) – v0.2 status
